name: Auto Release on rumdl Update

on:
  repository_dispatch:
    types: [rumdl_release]
  workflow_dispatch:
    inputs:
      rumdl_version:
        description: 'rumdl version to bundle (without v prefix)'
        required: true
        type: string
      dry_run:
        description: 'Dry run mode (skip publishing)'
        required: false
        default: false
        type: boolean

jobs:
  # Phase 1: Verify release, bump version, commit changes
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      rumdl_version: ${{ steps.version.outputs.rumdl_version }}
      new_version: ${{ steps.bump.outputs.new_version }}

    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Determine rumdl version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ inputs.rumdl_version }}"
          fi
          echo "rumdl_version=$VERSION" >> $GITHUB_OUTPUT

          # Verify the version exists with retries (to handle API propagation delays)
          echo "Verifying rumdl v$VERSION exists..."
          MAX_RETRIES=3
          RETRY_DELAY=60

          for i in $(seq 1 $MAX_RETRIES); do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "https://api.github.com/repos/rvben/rumdl/releases/tags/v$VERSION")

            if [ "$RESPONSE" = "200" ]; then
              echo "âœ… rumdl v$VERSION found"
              break
            elif [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "â³ rumdl v$VERSION not found yet (attempt $i/$MAX_RETRIES), waiting ${RETRY_DELAY}s for API propagation..."
              sleep $RETRY_DELAY
            else
              echo "Error: rumdl v$VERSION not found on GitHub releases after $MAX_RETRIES attempts"
              exit 1
            fi
          done

      - name: Update rumdl version in download script
        run: |
          sed -i "s/const RUMDL_VERSION = '[0-9.]*'/const RUMDL_VERSION = '${{ steps.version.outputs.rumdl_version }}'/" scripts/download-rumdl.js

      - name: Download rumdl binary for schema sync
        run: |
          npm run clean-rumdl
          npm run download-rumdl-current

      - name: Sync schema from new rumdl binary
        run: npm run sync-schema

      - name: Run tests
        run: |
          npm run lint
          npm run compile-tests

      - name: Bump extension version
        id: bump
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          npm version patch --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "New version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG
        run: |
          # Create new changelog entry
          cat > CHANGELOG.tmp.md << EOF
          # Changelog

          ## [${{ steps.bump.outputs.new_version }}] - $(date +%Y-%m-%d)

          ### Changed
          - Updated bundled rumdl to v${{ steps.version.outputs.rumdl_version }}

          EOF

          # Append existing changelog content (skip the first line if it's the title)
          if [ -f CHANGELOG.md ]; then
            tail -n +2 CHANGELOG.md >> CHANGELOG.tmp.md
          fi

          mv CHANGELOG.tmp.md CHANGELOG.md

      - name: Clean bundled-tools before commit
        run: rm -rf bundled-tools

      - name: Commit and push changes
        if: ${{ !inputs.dry_run }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add scripts/download-rumdl.js package.json package-lock.json CHANGELOG.md
          # Add schema if it was updated
          git add -f schemas/ 2>/dev/null || true
          git commit -m "chore: update rumdl to v${{ steps.version.outputs.rumdl_version }}

          - Updated bundled rumdl binaries to v${{ steps.version.outputs.rumdl_version }}
          - Bumped extension version to ${{ steps.bump.outputs.new_version }}"
          git push origin main

  # Phase 2: Build platform-specific VSIX packages in parallel
  build:
    needs: prepare
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        include:
          - code-target: win32-x64
            rumdl-platform: win32-x64
          - code-target: darwin-x64
            rumdl-platform: darwin-x64
          - code-target: darwin-arm64
            rumdl-platform: darwin-arm64
          - code-target: linux-x64
            rumdl-platform: linux-x64
          - code-target: linux-arm64
            rumdl-platform: linux-arm64
          - code-target: alpine-x64
            rumdl-platform: linux-x64
          - code-target: alpine-arm64
            rumdl-platform: linux-arm64

    steps:
      - uses: actions/checkout@v6
        with:
          ref: main

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Download rumdl binary for ${{ matrix.code-target }}
        run: |
          npm run clean-rumdl
          npm run download-rumdl-target -- ${{ matrix.code-target }}
          ls -lh bundled-tools/

      - name: Build VSIX for ${{ matrix.code-target }}
        run: |
          npx @vscode/vsce package --target ${{ matrix.code-target }} \
            --out dist/rumdl-${{ needs.prepare.outputs.new_version }}-${{ matrix.code-target }}.vsix
          ls -lh dist/

      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-${{ matrix.code-target }}
          path: dist/*.vsix

  # Phase 3: Publish all platform-specific VSIXs
  publish:
    needs: [prepare, build]
    if: ${{ !inputs.dry_run }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6
        with:
          ref: main

      - uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Download all VSIX artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: vsix-*
          path: dist/
          merge-multiple: true

      - name: List VSIX files
        run: ls -lh dist/

      - name: Create and push tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag "v${{ needs.prepare.outputs.new_version }}"
          git push origin "v${{ needs.prepare.outputs.new_version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.new_version }}
          name: v${{ needs.prepare.outputs.new_version }}
          body: |
            ## Changes
            - Updated bundled rumdl to v${{ needs.prepare.outputs.rumdl_version }}
            - Platform-specific VSIX packages (~5 MB each instead of ~25 MB universal)

            ### rumdl v${{ needs.prepare.outputs.rumdl_version }} highlights
            See [rumdl release notes](https://github.com/rvben/rumdl/releases/tag/v${{ needs.prepare.outputs.rumdl_version }}) for details.

            ## Installation

            - **VS Code**: Install from the [VS Code Marketplace](https://marketplace.visualstudio.com/items?itemName=rvben.rumdl)
            - **Cursor/VSCodium**: Install from [Open VSX Registry](https://open-vsx.org/extension/rvben/rumdl)
            - **Manual**: Download the `.vsix` file for your platform below
          files: dist/*.vsix

      - name: Publish to VS Code Marketplace
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          npx @vscode/vsce publish --packagePath dist/*.vsix --pat $VSCE_PAT

      - name: Publish to Open VSX Registry
        env:
          OVSX_TOKEN: ${{ secrets.OVSX_TOKEN }}
        run: |
          npx ovsx publish --packagePath dist/*.vsix -p $OVSX_TOKEN

  # Dry run summary (separate job so it runs even when build/publish are skipped)
  dry-run-summary:
    needs: prepare
    if: ${{ inputs.dry_run }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Dry Run Summary
        run: |
          echo "## ðŸ§ª Dry Run Complete!"
          echo ""
          echo "Would have performed:"
          echo "- Updated rumdl to v${{ needs.prepare.outputs.rumdl_version }}"
          echo "- Bumped extension version to ${{ needs.prepare.outputs.new_version }}"
          echo "- Built 7 platform-specific VSIX packages:"
          echo "  - win32-x64, darwin-x64, darwin-arm64"
          echo "  - linux-x64, linux-arm64"
          echo "  - alpine-x64, alpine-arm64"
          echo "- Created git tag v${{ needs.prepare.outputs.new_version }}"
          echo "- Published to VS Code Marketplace"
          echo "- Published to Open VSX Registry"
          echo ""
          echo "Files changed:"
          git diff --name-only
          echo ""
          echo "To perform actual release, run without dry_run flag"
